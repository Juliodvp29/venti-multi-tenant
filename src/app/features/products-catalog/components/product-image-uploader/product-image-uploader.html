<div class="space-y-3">

    <!-- Dropzone -->
    <div class="relative flex flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed transition-all duration-150 cursor-pointer py-6 px-4 text-center"
        [class.border-indigo-400]="isDragging()" [class.bg-indigo-50]="isDragging()"
        [class.dark:bg-indigo-950]="isDragging()" [class.border-gray-300]="!isDragging()"
        [class.dark:border-gray-600]="!isDragging()" [class.hover:border-indigo-400]="!isDragging()"
        (dragover)="onDragOver($event)" (dragleave)="onDragLeave()" (drop)="onDrop($event)" (click)="openFilePicker()">

        <input #fileInput type="file" multiple accept="image/*" class="hidden" (change)="onFileSelected($event)" />

        <div class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/40">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
            </svg>
        </div>
        <div>
            <p class="text-sm font-medium text-gray-700 dark:text-gray-300">
                <span class="text-indigo-600 dark:text-indigo-400">Haz clic para subir</span> o arrastra imágenes aquí
            </p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-0.5">PNG, JPG, WebP — máx. 5 MB por imagen</p>
        </div>
    </div>

    <!-- Image grid: saved + pending -->
    @if (savedImages().length > 0 || pendingImages().length > 0) {
    <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">

        <!-- Saved images -->
        @for (img of savedImages(); track img.id) {
        <div
            class="group relative rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 aspect-square bg-gray-50 dark:bg-gray-800">
            <img [src]="img.url" [alt]="img.alt_text ?? 'Imagen'" class="w-full h-full object-cover" />

            <!-- Primary badge -->
            @if (img.is_primary) {
            <div
                class="absolute top-1 left-1 bg-indigo-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full leading-none">
                Principal
            </div>
            }

            <!-- Hover overlay -->
            <div
                class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                <!-- Set primary -->
                @if (!img.is_primary) {
                <button type="button" (click)="setPrimaryImage(img); $event.stopPropagation()"
                    title="Hacer imagen principal"
                    class="p-1.5 rounded-full bg-white/20 hover:bg-white/40 text-white transition-colors">
                    <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 2.25l2.935 6.262 6.565.956-4.75 4.629 1.121 6.538L12 17.687l-5.871 3.088 1.121-6.538L2.5 9.468l6.565-.956L12 2.25z" />
                    </svg>
                </button>
                }
                <!-- Delete -->
                <button type="button" (click)="deleteSavedImage(img); $event.stopPropagation()" title="Eliminar imagen"
                    class="p-1.5 rounded-full bg-white/20 hover:bg-red-500/80 text-white transition-colors">
                    <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        }

        <!-- Pending images (not yet uploaded) -->
        @for (item of pendingImages(); track item.previewUrl) {
        <div
            class="group relative rounded-lg overflow-hidden border border-dashed border-indigo-300 dark:border-indigo-700 aspect-square bg-indigo-50/50 dark:bg-indigo-950/30">
            <img [src]="item.previewUrl" alt="Vista previa" class="w-full h-full object-cover"
                [class.opacity-50]="item.uploading" />

            <!-- Uploading spinner -->
            @if (item.uploading) {
            <div class="absolute inset-0 flex items-center justify-center">
                <svg class="animate-spin h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.823 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
            }

            <!-- Pending label + remove -->
            @if (!item.uploading) {
            <div
                class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                <button type="button" (click)="removePendingImage(item); $event.stopPropagation()" title="Quitar imagen"
                    class="p-1.5 rounded-full bg-white/20 hover:bg-red-500/80 text-white transition-colors">
                    <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Pending indicator -->
            <div
                class="absolute bottom-1 left-1 right-1 text-[9px] text-center bg-black/50 text-white rounded px-1 py-0.5 leading-tight">
                Pendiente
            </div>
            }
        </div>
        }

    </div>
    }

    <!-- Summary -->
    @if (savedImages().length > 0 || pendingImages().length > 0) {
    <p class="text-xs text-gray-400 dark:text-gray-500">
        {{ savedImages().length }} guardada{{ savedImages().length !== 1 ? 's' : '' }}
        @if (pendingImages().length > 0) {
        · <span class="text-indigo-500">{{ pendingImages().length }} pendiente{{ pendingImages().length !== 1 ? 's' : ''
            }} (se subirán al guardar)</span>
        }
    </p>
    }

</div>